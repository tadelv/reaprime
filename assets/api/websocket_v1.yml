asyncapi: 3.0.0
info:
  title: Rea Prime AsyncAPI
  version: 1.0.0
  description: >
    AsyncAPI specification for Rea Prime WebSocket data streams.


    Most channels are WebSocket-based and emit JSON messages to the client.
    The Devices channel is bidirectional, accepting commands and emitting state.

    These channels provide live updates from the DE1 espresso machine, scale,
    sensors, and connected devices.
servers:
  production:
    host: '{tablet-ip}:8080'
    protocol: ws
    description: WebSocket server providing live updates
    variables:
      tablet-ip:
        default: localhost
channels:
  MachineSnapshot:
    address: ws/v1/machine/snapshot
    description: Real-time snapshot data from the espresso machine.
    messages:
      machineSnapshotMessage:
        $ref: '#/components/messages/MachineSnapshot'
  ShotSettings:
    description: Real-time shot settings updates.
    address: ws/v1/machine/shotSettings
    messages:
      shotSettingsMessage:
        $ref: '#/components/messages/ShotSettings'
  WaterLevels:
    description: Real-time water level updates.
    address: ws/v1/machine/waterLevels
    messages:
      waterLevelsMessage:
        $ref: '#/components/messages/WaterLevels'
  ScaleSnapshot:
    description: Real-time scale weight and battery data.
    address: ws/v1/scale/snapshot
    messages:
      scaleSnapshotMessage:
        $ref: '#/components/messages/ScaleSnapshot'
  MachineRaw:
    description: Real-time raw BLE data from machine (read/write/notify).
    address: ws/v1/machine/raw
    messages:
      machineRawMessage:
        $ref: '#/components/messages/MachineRawMessage'
  SensorSnapshot:
    description: Real-time sensor snapshot updates for a specific sensor.
    address: ws/v1/sensors/{id}/snapshot
    parameters:
      id:
        description: Unique sensor identifier.
    messages:
      sensorSnapshotMessage:
        $ref: '#/components/messages/SensorSnapshot'
  Plugins:
    description: Outgoing messages from Rea plugins.
    address: ws/v1/plugins/{id}/{endpoint}
    parameters:
      id:
        description: Unique plugin identifier.
      endpoint:
        description: Plugin specific endpoint.
    messages:
      pluginMessage:
        $ref: '#/components/messages/PluginMessage'
  Logs:
    description: Subscribe to Rea logs
    address: ws/v1/logs
    messages:
      logMessage:
        $ref: '#/components/messages/LogMessage'
  Devices:
    description: >
      Bidirectional channel for device list state and commands.
      Emits full device state snapshots on connect, device list changes,
      individual device connection state changes, and scanning state changes.
      Accepts commands to scan, connect, and disconnect devices.
    address: ws/v1/devices
    messages:
      devicesState:
        $ref: '#/components/messages/DevicesState'
      devicesCommand:
        $ref: '#/components/messages/DevicesCommand'

operations:
  machineSnapshot:
    action: receive
    channel:
      $ref: '#/channels/MachineSnapshot'
  shotSettings:
    action: receive
    channel:
      $ref: '#/channels/ShotSettings'
  waterLevels:
    action: receive
    channel:
      $ref: '#/channels/WaterLevels'
  scaleSnapshot:
    action: receive
    channel:
      $ref: '#/channels/ScaleSnapshot'
  machineRaw:
    action: receive
    channel:
      $ref: '#/channels/MachineRaw'
  sensorSnapshot:
    action: receive
    channel:
      $ref: '#/channels/SensorSnapshot'
  pluginMessage:
    action: receive
    channel:
      $ref: '#/channels/Plugins'
  logMessage:
    action: receive
    channel:
      $ref: '#/channels/Logs'
  devicesState:
    action: receive
    channel:
      $ref: '#/channels/Devices'
    messages:
      - $ref: '#/channels/Devices/messages/devicesState'
  devicesCommand:
    action: send
    channel:
      $ref: '#/channels/Devices'
    messages:
      - $ref: '#/channels/Devices/messages/devicesCommand'

components:
  messages:
    Error:
      name: Error
      title: Error message
      payload:
        $ref: '#/components/schemas/Error'
    ScaleSnapshot:
      name: ScaleSnapshot
      title: Scale Snapshot
      payload:
        $ref: '#/components/schemas/ScaleSnapshot'
    MachineSnapshot:
      name: MachineSnapshot
      title: Machine Snapshot
      payload:
        $ref: '#/components/schemas/MachineSnapshot'
    ShotSettings:
      name: ShotSettings
      title: Shot Settings
      payload:
        $ref: '#/components/schemas/ShotSettings'
    WaterLevels:
      name: WaterLevels
      title: Water Levels
      payload:
        $ref: '#/components/schemas/WaterLevels'
    MachineRawMessage:
      name: MachineRawMessage
      title: Machine Raw BLE Message
      payload:
        $ref: '#/components/schemas/De1RawMessage'
    SensorSnapshot:
      name: SensorSnapshot
      title: Sensor Snapshot
      payload:
        $ref: '#/components/schemas/SensorSnapshot'
    PluginMessage:
      name: PluginMessage
      title: Message from plugin
      payload:
        $ref: '#/components/schemas/PluginMessage'
    LogMessage:
      name: LogMessage
      title: Log message from Rea
      payload:
        $ref: '#/components/schemas/LogMessage'
    DevicesState:
      name: DevicesState
      title: Device list state
      summary: Full snapshot of all known devices and scanning state.
      payload:
        $ref: '#/components/schemas/DevicesState'
    DevicesCommand:
      name: DevicesCommand
      title: Device command
      summary: Command sent by the client to scan, connect, or disconnect devices.
      payload:
        $ref: '#/components/schemas/DevicesCommand'
  schemas:
    Error:
      type: object
      properties:
        e:
          type: string
        st:
          type: string
    ScaleSnapshot:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        weight:
          type: number
        batteryLevel:
          type: integer
        timerValue:
          type: integer
          nullable: true
          description: Timer elapsed time in milliseconds. Null if scale doesn't support timers or timer hasn't been started.
    MachineSnapshot:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        state:
          type: object
          properties:
            state:
              $ref: '#/components/schemas/MachineState'
            substate:
              $ref: '#/components/schemas/MachineSubstate'
        flow:
          type: number
        pressure:
          type: number
          example: 6.2
        targetFlow:
          type: number
        targetPressure:
          type: number
        mixTemperature:
          type: number
        groupTemperature:
          type: number
        targetMixTemperature:
          type: number
        targetGroupTemperature:
          type: number
        profileFrame:
          type: integer
        steamTemperature:
          type: number
    MachineState:
      type: string
      enum:
        - idle
        - booting
        - sleeping
        - heating
        - preheating
        - espresso
        - hotWater
        - flush
        - steam
        - skipStep
        - cleaning
        - descaling
        - transportMode
        - needsWater
        - error
      example: espresso
    MachineSubstate:
      type: string
      enum:
        - idle
        - preparingForShot
        - preinfusion
        - pouring
        - pouringDone
        - cleaningStart
        - cleaingGroup
        - cleanSoaking
        - cleaningSteam
      example: preparingForShot
    ShotSettings:
      type: object
      properties:
        steamSetting:
          type: integer
        targetSteamTemp:
          type: number
        targetSteamDuration:
          type: integer
        targetHotWaterTemp:
          type: number
        targetHotWaterVolume:
          type: number
        targetHotWaterDuration:
          type: integer
        targetShotVolume:
          type: number
        groupTemp:
          type: number
    WaterLevels:
      type: object
      properties:
        currentLevel:
          type: number
          description: Current water height in the tank (mm)
        refillLevel:
          type: number
          description: Water level threshold for refill warning (mm)
    De1RawMessage:
      type: object
      required:
        - type
        - operation
        - characteristicUUID
        - payload
      properties:
        type:
          $ref: '#/components/schemas/De1RawMessageType'
        operation:
          $ref: '#/components/schemas/De1RawOperationType'
        characteristicUUID:
          type: string
          description: UUID of the characteristic (len = 4).
        payload:
          type: string
          description: The data payload as a hex string.
    De1RawMessageType:
      type: string
      enum:
        - request
        - response
      description: Type of raw message indicating whether it's a request or response.
    De1RawOperationType:
      type: string
      enum:
        - read
        - write
        - notify
      description: Operation type indicating the nature of the raw message.
    SensorSnapshot:
      type: object
      required:
        - values
      properties:
        timestamp:
          type: string
          format: date-time
        id:
          type: string
          description: Sensor identifier
        values:
          type: object
          additionalProperties: true

    PluginMessage:
      type: object
      additionalProperties: true

    LogMessage:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
        level:
          type: string
        message:
          type: string

    DevicesState:
      type: object
      required:
        - timestamp
        - devices
        - scanning
      properties:
        timestamp:
          type: string
          format: date-time
        devices:
          type: array
          items:
            $ref: '#/components/schemas/DeviceInfo'
        scanning:
          type: boolean
          description: Whether a BLE/USB scan is currently in progress.

    DeviceInfo:
      type: object
      required:
        - name
        - id
        - state
        - type
      properties:
        name:
          type: string
          example: DE1
        id:
          type: string
          description: Device identifier (BLE MAC, UUID, or serial port path).
          example: 'AA:BB:CC:DD:EE:FF'
        state:
          type: string
          enum:
            - connecting
            - connected
            - disconnecting
            - disconnected
          example: connected
        type:
          type: string
          enum:
            - machine
            - scale
            - sensor
          example: machine

    DevicesCommand:
      type: object
      required:
        - command
      properties:
        command:
          type: string
          enum:
            - scan
            - connect
            - disconnect
          description: The command to execute.
        deviceId:
          type: string
          description: Device identifier. Required for connect and disconnect commands.
        connect:
          type: boolean
          description: Whether to auto-connect discovered devices (scan command only).
          default: false
        quick:
          type: boolean
          description: Fire-and-forget scan without waiting for results (scan command only).
          default: false

