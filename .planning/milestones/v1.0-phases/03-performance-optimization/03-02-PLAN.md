---
phase: 03-performance-optimization
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - lib/src/controllers/device_controller.dart
autonomous: false

must_haves:
  truths:
    - "Reconnection events log how long the device was disconnected"
    - "Connection failure diagnostics are captured in telemetry without impacting scan/connect flow"
    - "App maintains smooth scan/connect flow under telemetry load (verified via DevTools)"
  artifacts:
    - path: "lib/src/controllers/device_controller.dart"
      provides: "Disconnection timestamp tracking and reconnection logging with duration"
      contains: "_disconnectedAt"
  key_links:
    - from: "lib/src/controllers/device_controller.dart"
      to: "lib/src/services/telemetry/telemetry_service.dart"
      via: "setCustomKey with reconnection_duration and log() with disconnection context"
      pattern: "reconnect"
---

<objective>
Add reconnection event tracking to DeviceController so disconnection duration is captured in telemetry, then verify the full telemetry pipeline adds zero jank during scan/connect flows via manual DevTools profiling.

Purpose: Connection failure diagnostics are the primary telemetry value — understanding why connections fail and how long devices stay disconnected enables remedies. The profiling checkpoint validates that all Phase 3 work (LogBuffer fix, report queue, reconnection tracking) meets the "UI always wins" requirement.

Output: DeviceController tracks disconnection timestamps and logs reconnection duration. User-verified smooth DevTools timeline during scan/connect.
</objective>

<execution_context>
@/Users/vid/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vid/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-performance-optimization/03-CONTEXT.md
@.planning/phases/03-performance-optimization/03-01-SUMMARY.md
@lib/src/controllers/device_controller.dart
@lib/src/services/telemetry/telemetry_service.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reconnection event tracking with disconnection duration</name>
  <files>
    lib/src/controllers/device_controller.dart
  </files>
  <action>
Add disconnection timestamp tracking and reconnection duration logging to DeviceController:

1. Add a `Map<String, DateTime> _disconnectedAt = {}` field to track when each device was last seen disconnecting. Key by device name (same key used in existing `_updateDeviceCustomKeys`).

2. In `_serviceUpdate()` (the method called when discovery services report device changes), compare the new device list against previously known devices:
   - **Device disappeared** (was in previous update, not in current): Record `_disconnectedAt[device.name] = DateTime.now()`. Log at INFO level: `"Device ${device.name} disconnected"`.
   - **Device reappeared** (in current update, has entry in `_disconnectedAt`): Calculate duration = `DateTime.now().difference(_disconnectedAt[device.name]!)`. Log at INFO level: `"Device ${device.name} reconnected after ${duration.inSeconds}s"`. Set telemetry custom key `reconnection_duration_${device.name}` to duration in seconds. Remove from `_disconnectedAt` map.

3. To track "previous devices", add a `Set<String> _previousDeviceNames = {}` field. Update it at the end of `_serviceUpdate()` after processing.

4. Keep existing `_updateDeviceCustomKeys()` call — it already handles device type and count tracking. The reconnection tracking is additive.

5. Clean up `_disconnectedAt` entries older than 24 hours in `_serviceUpdate()` to prevent unbounded memory growth during long-running gateway sessions. Simple: iterate and remove entries where `DateTime.now().difference(timestamp).inHours > 24`.

Per user decision: "BLE reconnections are continuations, not new sessions — same telemetry context, reconnection logged as event with duration-disconnected."
  </action>
  <verify>
    Run `flutter analyze lib/src/controllers/device_controller.dart` — no errors or warnings.
  </verify>
  <done>
    DeviceController tracks disconnection timestamps per device. Reconnection events log duration disconnected at INFO level and set telemetry custom keys. Stale entries cleaned up after 24 hours.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify telemetry adds zero jank during scan/connect via DevTools</name>
  <files>n/a (verification checkpoint)</files>
  <action>
This is a human verification checkpoint. No code changes — verify the full Phase 3 telemetry pipeline.

**What was built:**
- LogBuffer now properly enforces 16kb byte-size limit (Plan 01, Task 1)
- Report queue defers Firebase calls off the UI thread (Plan 01, Task 2)
- Reconnection tracking captures disconnection duration (Plan 02, Task 1)
- Rate limiter (Phase 2) remains as first line of defense

**How to verify:**
1. Run the app with a connected DE1 or in simulate mode: `flutter run --dart-define=simulate=1`
2. Open Flutter DevTools (click the DevTools link in terminal or use `flutter pub global run devtools`)
3. Go to the **Performance** tab in DevTools
4. Click "Record" to start timeline recording
5. Trigger a device scan (press the Scan button in the app UI, or call `POST /api/v1/devices/scan`)
6. If using real hardware: power-cycle a device mid-connection to trigger reconnection tracking
7. Stop recording after 10-15 seconds
8. **Verify:**
   - No jank frames (red bars) during the scan/connect period
   - Frame rendering stays under 16ms consistently
   - No long synchronous blocks from telemetry code in the timeline
9. Check the app logs (`GET /api/v1/logs` or console output) for:
   - Reconnection events with duration (if hardware was power-cycled)
   - Normal WARNING+ captures in log buffer
10. Optionally: check that log buffer size stays reasonable after extended operation

**Priority platforms:** Android tablet and macOS (per user decision).
**Key scenario:** scan for devices, attempt connections (some fail), verify telemetry captures diagnostics without impacting scan/connect flow.
  </action>
  <verify>Human confirms DevTools timeline shows no jank during scan/connect flows.</verify>
  <done>DevTools profiling confirms zero UI jank from telemetry during device scan and connection attempts. App maintains 60fps during BLE operations with telemetry active.</done>
</task>

</tasks>

<verification>
1. `flutter analyze lib/src/controllers/device_controller.dart` passes
2. DeviceController has `_disconnectedAt` tracking map
3. Reconnection events logged with duration
4. DevTools timeline shows no jank during scan/connect (human verified)
</verification>

<success_criteria>
- Reconnection events include duration-disconnected in seconds
- Telemetry custom keys include reconnection_duration per device
- DevTools profiling confirms zero UI jank during scan/connect flows
- App maintains smooth operation during device discovery with telemetry active
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-optimization/03-02-SUMMARY.md`
</output>
