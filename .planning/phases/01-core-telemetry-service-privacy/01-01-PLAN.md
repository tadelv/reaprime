---
phase: 01-core-telemetry-service-privacy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/src/services/telemetry/telemetry_service.dart
  - lib/src/services/telemetry/firebase_crashlytics_telemetry_service.dart
  - lib/src/services/telemetry/noop_telemetry_service.dart
  - lib/src/services/telemetry/anonymization.dart
  - lib/src/services/telemetry/log_buffer.dart
  - pubspec.yaml
autonomous: true

must_haves:
  truths:
    - "TelemetryService abstract interface exists with recordError(), log(), setCustomKey(), setConsentEnabled(), getLogBuffer()"
    - "FirebaseCrashlyticsTelemetryService implements TelemetryService using firebase_crashlytics"
    - "NoOpTelemetryService implements TelemetryService with empty method bodies"
    - "Anonymization utility hashes BLE MAC addresses and IP addresses with SHA-256 + salt"
    - "LogBuffer maintains a rolling 16kb circular buffer of log messages"
  artifacts:
    - path: "lib/src/services/telemetry/telemetry_service.dart"
      provides: "Abstract TelemetryService interface"
      exports: ["TelemetryService"]
    - path: "lib/src/services/telemetry/firebase_crashlytics_telemetry_service.dart"
      provides: "Firebase Crashlytics implementation"
      exports: ["FirebaseCrashlyticsTelemetryService"]
    - path: "lib/src/services/telemetry/noop_telemetry_service.dart"
      provides: "No-op fallback for unsupported platforms"
      exports: ["NoOpTelemetryService"]
    - path: "lib/src/services/telemetry/anonymization.dart"
      provides: "MAC and IP anonymization utilities"
      exports: ["Anonymization"]
    - path: "lib/src/services/telemetry/log_buffer.dart"
      provides: "16kb rolling circular log buffer"
      exports: ["LogBuffer"]
  key_links:
    - from: "lib/src/services/telemetry/firebase_crashlytics_telemetry_service.dart"
      to: "firebase_crashlytics"
      via: "FirebaseCrashlytics.instance method calls"
      pattern: "FirebaseCrashlytics\\.instance"
    - from: "lib/src/services/telemetry/anonymization.dart"
      to: "package:crypto"
      via: "SHA-256 hashing"
      pattern: "sha256\\.convert"
    - from: "lib/src/services/telemetry/log_buffer.dart"
      to: "circular_buffer"
      via: "CircularBuffer usage"
      pattern: "CircularBuffer"
---

<objective>
Create the core telemetry service infrastructure: abstract interface, Firebase Crashlytics implementation, no-op fallback, privacy anonymization utilities, and 16kb rolling log buffer.

Purpose: Establishes the foundation for all telemetry in the app. These files are self-contained and have no dependencies on existing app code beyond packages already in pubspec.yaml.
Output: Five new Dart files under lib/src/services/telemetry/ plus circular_buffer dependency.
</objective>

<execution_context>
@/Users/vid/.claude/get-shit-done/workflows/execute-plan.md
@/Users/vid/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-telemetry-service-privacy/01-RESEARCH.md
@lib/src/services/storage/kv_store_service.dart
@lib/src/models/data/profile_hash.dart
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add circular_buffer dependency and create TelemetryService interface + implementations</name>
  <files>
    pubspec.yaml
    lib/src/services/telemetry/telemetry_service.dart
    lib/src/services/telemetry/firebase_crashlytics_telemetry_service.dart
    lib/src/services/telemetry/noop_telemetry_service.dart
  </files>
  <action>
    1. Add `circular_buffer: ^0.12.0` to pubspec.yaml dependencies section, then run `flutter pub get`.

    2. Create `lib/src/services/telemetry/telemetry_service.dart` with an abstract class `TelemetryService`:
       - `Future<void> initialize()` — platform-specific setup
       - `Future<void> recordError(Object error, StackTrace? stackTrace, {bool fatal = false})` — report errors
       - `Future<void> log(String message)` — log a message to the telemetry service
       - `Future<void> setCustomKey(String key, Object value)` — set contextual key-value pairs
       - `Future<void> setConsentEnabled(bool enabled)` — enable/disable telemetry collection
       - `String getLogBuffer()` — retrieve current log buffer contents (for attaching to reports)
       - Match the pattern from `kv_store_service.dart` (simple abstract class, no mixin).
       - Add a factory constructor or static method `TelemetryService.create()` that returns `FirebaseCrashlyticsTelemetryService` on Android/iOS/macOS/Windows and `NoOpTelemetryService` on Linux. Use `dart:io` `Platform.isLinux` for the check. Also check `kDebugMode` from `package:flutter/foundation.dart` and `const String.fromEnvironment("simulate")` — if either is true, return `NoOpTelemetryService` regardless of platform (requirement TELE-05).

    3. Create `lib/src/services/telemetry/firebase_crashlytics_telemetry_service.dart`:
       - Implements `TelemetryService`
       - Constructor takes a `LogBuffer` instance (from log_buffer.dart, created in Task 2)
       - `initialize()`: calls `FirebaseCrashlytics.instance.setCrashlyticsCollectionEnabled(false)` immediately (PRIV-04 — disabled until consent)
       - `recordError()`: calls `FirebaseCrashlytics.instance.recordError(error, stackTrace, fatal: fatal)`. Before recording, call `FirebaseCrashlytics.instance.setCustomKey('log_buffer', _logBuffer.getContents())` to attach rolling log context.
       - `log()`: calls `FirebaseCrashlytics.instance.log(message)` AND appends to `_logBuffer`
       - `setCustomKey()`: calls `FirebaseCrashlytics.instance.setCustomKey(key, value)`
       - `setConsentEnabled()`: calls `FirebaseCrashlytics.instance.setCrashlyticsCollectionEnabled(enabled)`
       - `getLogBuffer()`: returns `_logBuffer.getContents()`
       - Import from `package:firebase_crashlytics/firebase_crashlytics.dart`

    4. Create `lib/src/services/telemetry/noop_telemetry_service.dart`:
       - Implements `TelemetryService`
       - All methods are no-ops (empty body or return empty string for getLogBuffer)
       - No external dependencies beyond the interface
       - Use `package:logging` to log a single INFO message in `initialize()`: "Telemetry disabled (NoOp mode)"
  </action>
  <verify>
    Run `flutter analyze lib/src/services/telemetry/` — no errors or warnings.
    Run `flutter pub get` — succeeds.
  </verify>
  <done>
    TelemetryService abstract interface exists with all required methods. FirebaseCrashlyticsTelemetryService wraps Firebase Crashlytics with consent-off-by-default. NoOpTelemetryService provides a silent fallback. Factory method returns correct implementation based on platform and build mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Anonymization utility and LogBuffer</name>
  <files>
    lib/src/services/telemetry/anonymization.dart
    lib/src/services/telemetry/log_buffer.dart
  </files>
  <action>
    1. Create `lib/src/services/telemetry/anonymization.dart`:
       - Class `Anonymization` with static methods (follows `ProfileHash` pattern from profile_hash.dart)
       - `static const String _salt = 'reaprime-telemetry-v1'` — fixed app-specific salt (per research recommendation for Phase 1)
       - `static String anonymizeMac(String macAddress)`:
         - Normalize: uppercase, remove colons and dashes
         - Concatenate: `'$_salt:mac:$normalized'`
         - SHA-256 hash using `package:crypto` (already a transitive dependency, used in profile_hash.dart)
         - Return `'mac_${hash.toString().substring(0, 16)}'` (16 hex chars = 64 bits, sufficient for correlation without reversibility)
       - `static String anonymizeIp(String ipAddress)`:
         - Concatenate: `'$_salt:ip:$ipAddress'`
         - SHA-256 hash
         - Return `'ip_${hash.toString().substring(0, 16)}'`
       - `static String anonymize(String input)`:
         - General-purpose method for other PII if needed
         - Detect MAC pattern (XX:XX:XX:XX:XX:XX or XX-XX-XX-XX-XX-XX) -> route to anonymizeMac
         - Detect IPv4 pattern (N.N.N.N) -> route to anonymizeIp
         - Detect IPv6 pattern (contains multiple colons and hex chars) -> route to anonymizeIp
         - Otherwise return input unchanged
       - `static String scrubString(String text)`:
         - Find all MAC addresses in text using regex `([0-9A-Fa-f]{2}[:-]){5}[0-9A-Fa-f]{2}` and replace with anonymized versions
         - Find all IPv4 addresses using regex `\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b` and replace with anonymized versions
         - Returns cleaned text (for scrubbing log messages before upload)
       - Import `dart:convert` and `package:crypto/crypto.dart`

    2. Create `lib/src/services/telemetry/log_buffer.dart`:
       - Class `LogBuffer`
       - `static const int maxSizeBytes = 16 * 1024` (16kb per decision)
       - Private `CircularBuffer<String> _buffer` initialized with capacity 500 (average 32 bytes/message * 500 = 16kb)
       - Private `int _currentSizeBytes = 0` tracking actual byte usage
       - `void append(String message)`:
         - Create timestamped entry: `'[${DateTime.now().toIso8601String()}] $message'`
         - Before adding, if buffer is full (at capacity), subtract the size of the entry that will be evicted (the oldest, at index 0 if isFilled) from `_currentSizeBytes`
         - Add to buffer
         - Add new entry's length to `_currentSizeBytes`
         - Trim: while `_currentSizeBytes > maxSizeBytes && _buffer.isNotEmpty`, remove oldest entry and subtract its length
       - `String getContents()`: returns `_buffer.join('\n')`
       - `void clear()`: clears buffer, resets `_currentSizeBytes` to 0
       - `int get currentSizeBytes => _currentSizeBytes`
       - `int get entryCount => _buffer.length`
       - Import `package:circular_buffer/circular_buffer.dart`
  </action>
  <verify>
    Run `flutter analyze lib/src/services/telemetry/` — no errors or warnings.
    Verify `circular_buffer` import resolves: `flutter pub get` succeeds.
  </verify>
  <done>
    Anonymization.anonymizeMac() and Anonymization.anonymizeIp() produce consistent, salted SHA-256 hashes. Anonymization.scrubString() finds and replaces all MAC and IP addresses in arbitrary text. LogBuffer maintains a rolling 16kb circular buffer with byte-size tracking and timestamped entries.
  </done>
</task>

</tasks>

<verification>
1. `flutter analyze lib/src/services/telemetry/` reports no issues
2. All five files exist under lib/src/services/telemetry/
3. TelemetryService.create() factory returns correct type based on platform
4. circular_buffer package is in pubspec.yaml and resolves
5. No imports reference files outside the telemetry directory (self-contained)
</verification>

<success_criteria>
- Five new files created in lib/src/services/telemetry/
- Abstract interface matches requirement TELE-01
- Firebase implementation wraps Crashlytics (TELE-02) with consent disabled by default (PRIV-04)
- NoOp implementation exists for Linux (TELE-03)
- Environment check returns NoOp for debug/simulate (TELE-05)
- MAC and IP anonymization uses salted SHA-256 (PRIV-01, PRIV-02)
- 16kb rolling log buffer with byte-size enforcement (LOGC-01)
- `flutter analyze` passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-telemetry-service-privacy/01-01-SUMMARY.md`
</output>
